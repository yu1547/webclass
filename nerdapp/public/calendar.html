<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Planner</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
        }
        .header h1{
            text-align: center;
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            color: #105aa7;
            text-align: center;
            align-items: center;
            padding: 10px;
            background-color: #c1d3ec;
            border: none;
            border-radius: 50px;
            width: 40%;
            margin-left: 30%;
            /* margin-right: 30%; */
            margin-top: 2%;
        }

        #ToDoList {
            list-style: none;
            padding: 10px;
            text-align: center;
            margin-top: 2%;
        }

        .schedule-item {
            font-family: 'Courier New', Courier, monospace;
            margin: 10px;
            padding: 10px 20px 10px 20px;
            border: 2px solid #105aa7;
            background-color: #c1d3ec;
            border-radius: 30px;
            display: inline-block;
            width: calc(25% - 10px);
            box-sizing: border-box;
        }

        .checkbox-label {
            margin-left: 10px;
        }

        #navbar {
            position: fixed;
            top: 12px;
            background-color: #105aa7;
            color: rgb(32, 32, 32);
            cursor: pointer;
            z-index: 1;
            padding: 3px;
            border-radius: 30px;
            text-align: left;
            margin-left: 2%;
        }

        #navbar:hover {
            border-radius: 30px;
            border: none;
        }

        .navbar-item {
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            padding: 7px;
            text-decoration: none;
            display: block;
            color: rgb(255, 255, 255);
        }

        .navbar-item:hover {
            background-color: #c1d3ec;
            color: #105aa7;
            border-radius: 30px;
            border: none;
        }

        #logoutButton {
            font-size: large;
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            padding: 10px;
            height: 50px;
            background-color: #ffde59;
            border-radius: 40px;
            border: none;
            text-align: center;
            vertical-align: middle;
            display: inline-block;
        }
        #logoutButton:hover{
            background-color: #f6e8b3;
        }
        @media only screen and (max-width: 1000px) {
            .schedule-item {
                width: 90%;
            }
            .header h1{
                width:80%;
                margin-left: 10%;
            }
        }
    </style>
</head>

<body>
    <div class="header"style="text-align: center;width: 100%;">
        <!-- <header> -->
            <h1>Schedule Planner</h1>
        <!-- </header> -->
    </div>
    <button id="logoutButton" style="position: absolute; top: 75px; left: 10px;">ÁôªÂá∫</button>
    <div id="navbar">
        <a href="#" class="navbar-item" id="reset">ÈáçÊñ∞Ë™øÊï¥</a>
    </div>
    <ul id="ToDoList">
    </ul>
    <script>
        let tests = [];
        let freeTime = [];
        // const tests = [
        //     {
        //         name: "ÊúüÊú´ËÄÉ",
        //         date: new Date("2023-12-31"),
        //         importance: 6,
        //         subject: [
        //             { name: "Êï∏Â≠∏", clock: 4, finish: 0 },
        //             { name: "Áâ©ÁêÜ", clock: 3, finish: 0 }
        //         ],
        //         finish: 0,
        //         total: 0
        //     },
        //     {
        //         name: "ÂæÆÁ©çÂàÜÂ∞èËÄÉ",
        //         date: new Date("2023-1-31"),
        //         importance: 2,
        //         subject: [
        //             { name: "ÂæÆÁ©çÂàÜ", clock: 13, finish: 0 },
        //         ],
        //         finish: 0,
        //         total: 0
        //     }
        // ];
        // Âú®ÂÆ¢Êà∂Á´Ø
        let unscheduledSubjectsList = [];
        $(document).ready(function () {
            // Ê™¢Êü•localStorage‰∏≠ÁöÑ'isLoggedIn'È†ÖÁõÆ
            var isLoggedIn = localStorage.getItem('isLoggedIn');

            // Â¶ÇÊûúÁî®Êà∂Êú™ÁôªÂÖ•ÔºåÂâáÈáçÂÆöÂêëÂà∞ÁôªÂÖ•È†ÅÈù¢
            // if (!isLoggedIn) {
            //     window.location.href = "/";
            // }
            $('#logoutButton').click(function () {
                // Ê∏ÖÈô§ localStorage 
                localStorage.clear();
                window.location.href = '/';
            });
            $('#reset').click(function (e) {
                e.preventDefault();
                const username = sessionStorage.getItem('username'); // Âæû session ‰∏≠Áç≤Âèñ username
                const confirmReset = confirm('Ê≠§Êìç‰ΩúÂ∞áÊúÉ‰ΩøtodolistÊ∏ÖÈô§ÔºåÊòØÂê¶ÁúüÁöÑË¶ÅÊ∏ÖÈô§Ôºü');
                if (confirmReset) {
                    let username = localStorage.getItem('username');
                    $.ajax({
                        url: '/clearTodoList',
                        type: 'PUT',
                        data: { username: username },
                        success: function (data) {
                            console.log('TodoList cleared successfully');
                            window.location.href = 'dashboard.html';
                        }
                    });
                }
            });
            let username = localStorage.getItem('username');
            $.ajax({
                url: '/getTest',
                type: 'GET',
                data: { username: username },
                success: function (data) {
                    // Â¶ÇÊûú‰ΩøÁî®ËÄÖÊúâÂÑ≤Â≠òÈÅé todolistÔºåÈÇ£È∫ºÂ∞±‰ΩøÁî®ÈÄôÂÄã todolist
                    if (data.todoList.length > 0) {
                        console.log(data.todoList)
                        displayTodoList(data.todoList);
                    } else {
                        // Âê¶ÂâáÔºåË®àÁÆóÊñ∞ÁöÑ todolist
                        tests = data.tests;
                        freeTime = data.freeTime;
                        resetSchedule();
                        displayTodoList(resultList);
                        console.log(resultList)
                        // ÂÑ≤Â≠òÊñ∞ÁöÑ todolist
                        $.ajax({
                            url: '/saveTodoList',
                            type: 'PUT',
                            data: JSON.stringify({ todoList: resultList, username: username }),
                            contentType: 'application/json',
                            success: function (data) {
                                console.log('TodoList saved successfully');
                            }
                        });
                    }
                }
            });
        });
        let resultList = [];
        function calculateWeight(exam, currentDate) {
            const daysDifference = Math.ceil((exam.date - currentDate) / (1000 * 60 * 60 * 24));
            // Â¶ÇÊûúËÄÉË©¶Áï∂Â§©ÔºåÂ∞áÊ¨äÈáçË®≠ÁÇ∫‰∏ÄÂÄãËºÉÂ§ßÁöÑÊï∏Â≠óÔºà‰æãÂ¶Ç10ÔºâÔºåÈÅøÂÖç‰ΩøÁî®Infinity
            return daysDifference === 0 ? 10 : exam.importance / daysDifference;
        }
        function findAvailableTime(currentDate) {
            return 60;
        }
        function findBestSubject(tests) {
            return tests[0];
        }
        const ToDoListElement = document.getElementById("ToDoList");
        const currentDate = new Date();
        const tomorrow = new Date(currentDate);
        tomorrow.setDate(currentDate.getDate() + 1);
        function resetSchedule() {
            console.log("Start resetSchedule"); // Êñ∞Â¢ûÈÄôË°å
            ToDoListElement.innerHTML = ""; // Ê∏ÖÁ©∫ ToDoList
            unscheduledSubjectsList = []; // Ê∏ÖÁ©∫Êú™ËÉΩÂÆâÊéíÁöÑÁßëÁõÆÂàóË°®
            while (tests.length > 0) {
                console.log("Inside loop"); // Êñ∞Â¢ûÈÄôË°å
                let availableTime = findAvailableTime(tomorrow);
                if (availableTime >= 25) {
                    console.log("Inside if statement"); // Êñ∞Â¢ûÈÄôË°å
                    const selectedItem = findBestSubject(tests);
                    const todoItem = {
                        name: selectedItem.name,
                        date: new Date(tomorrow),
                        importance: selectedItem.importance,
                        subject: selectedItem.subject[0].name,
                        clock: selectedItem.subject[0].clock,
                        finish: 0,
                        weight: calculateWeight(selectedItem, currentDate)
                    };
                    selectedItem.subject[0].clock -= 1;
                    if (selectedItem.subject[0].clock === 0) {
                        tests.splice(tests.indexOf(selectedItem), 1);
                    }
                    availableTime -= 25;
                    resultList.push(todoItem);
                    tomorrow.setMinutes(tomorrow.getMinutes() + 25);
                    if (resultList.length % 3 === 0) {
                        const breakElement = document.createElement("br");
                        ToDoListElement.appendChild(breakElement);
                    }
                } else {
                    console.log("Inside else statement"); // Êñ∞Â¢ûÈÄôË°å
                    // Ëã•ÁÑ°Ê≥ïÂÆâÊéíÔºåÂ∞áÁßëÁõÆÊ∑ªÂä†Âà∞Êú™ËÉΩÂÆâÊéíÁöÑÁßëÁõÆÂàóË°®
                    const unscheduledSubject = tests.shift();
                    unscheduledSubjectsList.push(unscheduledSubject);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(9, 0);
                }
            }
            console.log("End resetSchedule"); // Êñ∞Â¢ûÈÄôË°å
            resultList = resultList.filter(item => item.date >= currentDate);
            // resultList.forEach(item => {
            //     const minutes = item.date.getMinutes().toString().padStart(2, '0');
            //     const hours = item.date.getHours().toString().padStart(2, '0');
            //     const listItem = document.createElement("li");
            //     listItem.className = "schedule-item";
            //     listItem.innerHTML = `
            //             <strong>${item.name}</strong><br>
            //             Date: ${item.date.toLocaleDateString()}<br>
            //             Time: ${hours}:${minutes}<br>
            //             Subject: ${item.subject} (Ââ©‰∏ã${item.clock}&#127813)<br>
            //             <label class="checkbox-label">
            //                 <input type="checkbox"> Finish
            //             </label>
            //             <br>
            //         `;
            //     ToDoListElement.appendChild(listItem);
            // });
            // ÁèæÂú®Âú®ÁîüÊàêÂÆåË°åÁ®ãË°®ÂæåÊ™¢Êü•Êú™ËÉΩÂÆâÊéíÁöÑÁßëÁõÆ
            checkUnscheduledSubjects();
        }
        function displayTodoList(todo) {
            todo.forEach(item => {
                const date = new Date(item.date);
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const listItem = document.createElement("li");
                listItem.className = "schedule-item";
                listItem.innerHTML = `          <strong>${item.name}</strong><br>
            Date: ${date.toLocaleDateString()}<br>
            Time: ${hours}:${minutes}<br>
            Subject: ${item.subject} (Ââ©‰∏ã${item.clock}üçÖ)<br>
            <label class="checkbox-label">
                <input type="checkbox"> Finish
            </label>
            <br>
        `;
                ToDoListElement.appendChild(listItem);
            });
        }


        function checkUnscheduledSubjects() {
            const unscheduledSubjectsString = unscheduledSubjectsList
                .map(subject => `${subject.name} (Ââ©È§ò${subject.subject[0].clock}Â∞èÊôÇ)`)
                .join(", ");
            if (unscheduledSubjectsString) {
                window.alert(`‰ª•‰∏ãÁßëÁõÆÊú™ËÉΩÊéíÂÖ•Êó•Á®ãË°®: ${unscheduledSubjectsString}`);
            }
        }
        // ÂàùÂßãÂåñÈ†ÅÈù¢ÊôÇÂü∑Ë°å‰∏ÄÊ¨°
        resetSchedule();
    </script>
</body>

</html>