<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Planner</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
        }

        header h1 {
            text-align: center;
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            color: #105aa7;
            text-align: center;
            align-items: center;
            padding: 10px;
            background-color: #c1d3ec;
            border: none;
            border-radius: 50px;
            width: 400px;
            margin-left: 35%;
            margin-top: 2%;
        }

        #ToDoList {
            list-style: none;
            padding: 10px;
            text-align: center;
            margin-top: 2%;
        }

        .schedule-item {
            font-family: 'Courier New', Courier, monospace;
            margin: 10px;
            padding: 10px 20px 10px 20px;
            border: 2px solid #105aa7;
            background-color: #c1d3ec;
            border-radius: 30px;
            display: inline-block;
            width: calc(25% - 10px);
            box-sizing: border-box;
        }

        .checkbox-label {
            margin-left: 10px;
        }

        #navbar {
            position: fixed;
            top: 12px;
            background-color: #105aa7;
            color: rgb(32, 32, 32);
            cursor: pointer;
            z-index: 1;
            padding: 3px;
            border-radius: 30px;
            text-align: left;
            margin-left: 2%;
        }

        #navbar:hover {
            border-radius: 30px;
            border: none;
        }

        .navbar-item {
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            padding: 7px;
            text-decoration: none;
            display: block;
            color: rgb(255, 255, 255);
        }

        .navbar-item:hover {
            background-color: #c1d3ec;
            color: #105aa7;
            border-radius: 30px;
            border: none;
        }
    </style>

</head>

<body>
    <header>
        <h1>Schedule Planner</h1>
    </header>
    <div id="navbar">
        <a href="#" class="navbar-item" id="reset">é‡æ–°èª¿æ•´</a>
    </div>
    <ul id="ToDoList">

    </ul>

    <script>
        let tests = [];
        let freeTime = [];
        // const tests = [
        //     {
        //         name: "æœŸæœ«è€ƒ",
        //         date: new Date("2023-12-31"),
        //         importance: 6,
        //         subject: [
        //             { name: "æ•¸å­¸", clock: 4, finish: 0 },
        //             { name: "ç‰©ç†", clock: 3, finish: 0 }
        //         ],
        //         finish: 0,
        //         total: 0
        //     },
        //     {
        //         name: "å¾®ç©åˆ†å°è€ƒ",
        //         date: new Date("2023-1-31"),
        //         importance: 2,
        //         subject: [
        //             { name: "å¾®ç©åˆ†", clock: 13, finish: 0 },
        //         ],
        //         finish: 0,
        //         total: 0
        //     }
        // ];
        // åœ¨å®¢æˆ¶ç«¯
        let unscheduledSubjectsList = [];
        $(document).ready(function () {
            $('#reset').click(function (e) {
                e.preventDefault();
                const username = sessionStorage.getItem('username'); // å¾ session ä¸­ç²å– username
                const confirmReset = confirm('æ­¤æ“ä½œå°‡æœƒä½¿todolistæ¸…é™¤ï¼Œæ˜¯å¦çœŸçš„è¦æ¸…é™¤ï¼Ÿ');
                if (confirmReset) {
                    $.ajax({
                        url: '/clearTodoList',
                        type: 'PUT',
                        success: function (data) {
                            console.log('TodoList cleared successfully');
                            window.location.href = 'dashboard.html';
                        }
                    });
                }
            });

            $.ajax({
                url: '/getTest',
                type: 'GET',
                success: function (data) {
                    // å¦‚æœä½¿ç”¨è€…æœ‰å„²å­˜é todolistï¼Œé‚£éº¼å°±ä½¿ç”¨é€™å€‹ todolist
                    console.log("data.todoList.length", data.todoList.length)
                    if (data.todoList.length > 0) {
                        console.log(data.todoList)
                        displayTodoList(data.todoList);
                    } else {
                        // å¦å‰‡ï¼Œè¨ˆç®—æ–°çš„ todolist
                        tests = data.tests;
                        freeTime = data.freeTime;
                        resetSchedule();
                        displayTodoList(resultList);
                        console.log(resultList)
                        // å„²å­˜æ–°çš„ todolist
                        $.ajax({
                            url: '/saveTodoList',
                            type: 'PUT',
                            data: JSON.stringify({ todoList: resultList }),
                            contentType: 'application/json',
                            success: function (data) {
                                console.log('TodoList saved successfully');
                            }
                        });
                    }
                }
            });
        });


        let resultList = [];
        
        function isTimeInUserFreeSlot(freeTimeArray, day, time) {
            const dayTimeSlots = freeTimeArray.find((slot) => slot.day === day);
            
            if (dayTimeSlots) {
                const startTime = new Date(`1970-01-01 ${dayTimeSlots.startTime}`);
                const endTime = new Date(`1970-01-01 ${dayTimeSlots.endTime}`);
                const checkTime = new Date(`1970-01-01 ${time}`);
            
                return checkTime >= startTime && checkTime <= endTime;
            }
            
            return false;
            }
            
            // å‡½æ•¸ï¼šæª¢æŸ¥æŒ‡å®šçš„æ—¥æœŸæ˜¯å¦åœ¨ä½¿ç”¨è€…çš„ç©ºé–’æ™‚é–“ç¯„åœå…§
        function isDayInFreeTime(day, freeTimeArray) {
            const dayTimeSlots = freeTimeArray.find((slot) => slot.day === day);
            return !!dayTimeSlots;
        }

        function calculateWeight(exam, currentDate) {
            const daysDifference = Math.ceil((exam.date - currentDate) / (1000 * 60 * 60 * 24));
            // å¦‚æœè€ƒè©¦ç•¶å¤©ï¼Œå°‡æ¬Šé‡è¨­ç‚ºä¸€å€‹è¼ƒå¤§çš„æ•¸å­—ï¼ˆä¾‹å¦‚10ï¼‰ï¼Œé¿å…ä½¿ç”¨Infinity
            return daysDifference === 0 ? 10 : exam.importance / daysDifference;
        }


        function findAvailableTime(currentDate) {
            return 60;
        }

        function findBestSubject(tests) {
            return tests[0];
        }

        const ToDoListElement = document.getElementById("ToDoList");

        const currentDate = new Date();
        const tomorrow = new Date(currentDate);
        tomorrow.setDate(currentDate.getDate() + 1);

        function resetSchedule() {
            console.log("Start resetSchedule"); // æ–°å¢é€™è¡Œ

            ToDoListElement.innerHTML = ""; // æ¸…ç©º ToDoList
            unscheduledSubjectsList = []; // æ¸…ç©ºæœªèƒ½å®‰æ’çš„ç§‘ç›®åˆ—è¡¨

            while (tests.length > 0) {
                console.log("Inside loop"); // æ–°å¢é€™è¡Œ

                let availableTime = findAvailableTime(tomorrow);

                if (availableTime >= 25) {
                    console.log("Inside if statement"); // æ–°å¢é€™è¡Œ 

                    const selectedItem = findBestSubject(tests);
                    console.log(typeof selectedItem.date, selectedItem.date); //æª¢æŸ¥selectedItem.date æ˜¯ä¸æ˜¯Dateç‰©ä»¶
                    
                    const isDayFree = isDayInFreeTime(selectedItem.date, FreeTime);

                    
                    if (isDayFree){
                        const todoItem = {
                            name: selectedItem.name,
                            date: new Date(tomorrow),
                            importance: selectedItem.importance,
                            subject: selectedItem.subject[0].name,
                            clock: selectedItem.subject[0].clock,
                            finish: 0,
                            weight: calculateWeight(selectedItem, currentDate)
                        };
    
                        selectedItem.subject[0].clock -= 1;
                        if (selectedItem.subject[0].clock === 0) {
                            tests.splice(tests.indexOf(selectedItem), 1);
                        }
    
                        availableTime -= 25;
    
                        resultList.push(todoItem);
                        tomorrow.setMinutes(tomorrow.getMinutes() + 25);
    
                        if (resultList.length % 3 === 0) {
                            const breakElement = document.createElement("br");
                            ToDoListElement.appendChild(breakElement);
                        }
                    }    
                    else {
                    console.log("Inside else statement"); // æ–°å¢é€™è¡Œ
                    // è‹¥ç„¡æ³•å®‰æ’ï¼Œå°‡ç§‘ç›®æ·»åŠ åˆ°æœªèƒ½å®‰æ’çš„ç§‘ç›®åˆ—è¡¨
                    const unscheduledSubject = tests.shift();
                    unscheduledSubjectsList.push(unscheduledSubject);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(9, 0);
                    }
            }else{
                const unscheduledSubject = tests.shift();
                unscheduledSubjectsList.push(unscheduledSubject);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(9, 0);
            }
}
            console.log("End resetSchedule"); // æ–°å¢é€™è¡Œ
            resultList = resultList.filter(item => item.date >= currentDate);
            
            // resultList.forEach(item => {
            //     const minutes = item.date.getMinutes().toString().padStart(2, '0');
            //     const hours = item.date.getHours().toString().padStart(2, '0');
            //     const listItem = document.createElement("li");
            //     listItem.className = "schedule-item";
            //     listItem.innerHTML = `
            //             <strong>${item.name}</strong><br>
            //             Date: ${item.date.toLocaleDateString()}<br>
            //             Time: ${hours}:${minutes}<br>
            //             Subject: ${item.subject} (å‰©ä¸‹${item.clock}&#127813)<br>
            //             <label class="checkbox-label">
            //                 <input type="checkbox"> Finish
            //             </label>
            //             <br>
            //         `;
            //     ToDoListElement.appendChild(listItem);
            // });

            // ç¾åœ¨åœ¨ç”Ÿæˆå®Œè¡Œç¨‹è¡¨å¾Œæª¢æŸ¥æœªèƒ½å®‰æ’çš„ç§‘ç›®
            checkUnscheduledSubjects();
        }
        function displayTodoList(todo) {
            todo.forEach(item => {
                const date = new Date(item.date);
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const listItem = document.createElement("li");
                listItem.className = "schedule-item";
                listItem.innerHTML = `
            <strong>${item.name}</strong><br>
            Date: ${date.toLocaleDateString()}<br>
            Time: ${hours}:${minutes}<br>
            Subject: ${item.subject} (å‰©ä¸‹${item.clock}ğŸ…)<br>
            <br>
        `;
                ToDoListElement.appendChild(listItem);
            });
        }


        function checkUnscheduledSubjects() {
            const unscheduledSubjectsString = unscheduledSubjectsList
                .map(subject => `${subject.name} (å‰©é¤˜${subject.subject[0].clock}å°æ™‚)`)
                .join(", ");

            if (unscheduledSubjectsString) {
                window.alert(`ä»¥ä¸‹ç§‘ç›®æœªèƒ½æ’å…¥æ—¥ç¨‹è¡¨: ${unscheduledSubjectsString}`);
            }
        }


        // åˆå§‹åŒ–é é¢æ™‚åŸ·è¡Œä¸€æ¬¡
        resetSchedule();
    </script>
</body>

</html>